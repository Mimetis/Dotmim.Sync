using Dotmim.Sync.Batch;
using Dotmim.Sync.Enumerations;
using Dotmim.Sync.Web.Client.BackwardCompatibility;
using System;
using System.Runtime.Serialization;

namespace Dotmim.Sync.Web.Client
{

    /// <summary>
    /// Represents the SyncContext for the current sync session in an HTTP message.
    /// </summary>
    public interface IScopeMessage
    {
        /// <summary>
        /// Gets or Sets the SyncContext.
        /// </summary>
        SyncContext SyncContext { get; set; }
    }

    /// <summary>
    /// HttpMessage containing a batch changes from the server.
    /// </summary>
    [DataContract(Name = "changesres"), Serializable]
    public class HttpMessageSendChangesResponse : IScopeMessage
    {

        /// <inheritdoc cref="HttpMessageSendChangesResponse"/>/>
        public HttpMessageSendChangesResponse() { }

        /// <inheritdoc cref="HttpMessageSendChangesResponse"/>/>
        public HttpMessageSendChangesResponse(SyncContext context)
            => this.SyncContext = context ?? throw new ArgumentNullException(nameof(context));

        /// <summary>
        /// Gets or Sets the Server HttpStep.
        /// </summary>
        [DataMember(Name = "ss", IsRequired = true, Order = 1)]
        public HttpStep ServerStep { get; set; }

        /// <summary>
        /// Gets or Sets the SyncContext.
        /// </summary>
        [DataMember(Name = "sc", IsRequired = true, Order = 2)]
        public SyncContext SyncContext { get; set; }

        /// <summary>
        /// Gets or sets the current batch index, send from the server.
        /// </summary>
        [DataMember(Name = "bi", IsRequired = true, Order = 3)]
        public int BatchIndex { get; set; }

        /// <summary>
        /// Gets or sets the number of batch to send.
        /// </summary>
        [DataMember(Name = "bc", IsRequired = false, Order = 4)]
        public int BatchCount { get; set; }

        /// <summary>
        /// Gets or sets a value indicating whether gets or Sets if this is the last Batch send from the server.
        /// </summary>
        [DataMember(Name = "islb", IsRequired = true, Order = 5)]
        public bool IsLastBatch { get; set; }

        /// <summary>
        /// Gets or sets the remote client timestamp generated by the server database.
        /// </summary>
        [DataMember(Name = "rct", IsRequired = true, Order = 6)]
        public long RemoteClientTimestamp { get; set; }

        /// <summary>
        /// Gets or sets the BatchParInfo send from the server.
        /// </summary>
        [DataMember(Name = "changes", IsRequired = true, Order = 7)]
        public ContainerSet Changes { get; set; } // BE CAREFUL: If changes the order, change it too in "ContainerSetBoilerPlate" !

        /// <summary>
        /// Gets or sets the changes stats from the server.
        /// </summary>
        [DataMember(Name = "scs", IsRequired = true, Order = 8)]
        public DatabaseChangesSelected ServerChangesSelected { get; set; }

        /// <summary>
        /// Gets or sets the changes stats from the server.
        /// </summary>
        [DataMember(Name = "cca", IsRequired = true, Order = 9)]
        public DatabaseChangesApplied ClientChangesApplied { get; set; }

        /// <summary>
        /// Gets or Sets the conflict resolution policy from the server.
        /// </summary>
        [DataMember(Name = "policy", IsRequired = true, Order = 10)]
        public ConflictResolutionPolicy ConflictResolutionPolicy { get; set; }
    }

    /// <summary>
    /// HttpMessage to get more changes from the server.
    /// </summary>
    [DataContract(Name = "morechangesreq"), Serializable]
    public class HttpMessageGetMoreChangesRequest : IScopeMessage
    {
        /// <inheritdoc cref="HttpMessageGetMoreChangesRequest"/>/>
        public HttpMessageGetMoreChangesRequest() { }

        /// <inheritdoc cref="HttpMessageGetMoreChangesRequest"/>/>
        public HttpMessageGetMoreChangesRequest(SyncContext context, int batchIndexRequested)
        {
            this.BatchIndexRequested = batchIndexRequested;
            this.SyncContext = context ?? throw new ArgumentNullException(nameof(context));
        }

        /// <inheritdoc />
        [DataMember(Name = "sc", IsRequired = true, Order = 1)]
        public SyncContext SyncContext { get; set; }

        /// <summary>
        /// Gets or sets the batch index requested.
        /// </summary>
        [DataMember(Name = "bireq", IsRequired = true, Order = 2)]
        public int BatchIndexRequested { get; set; }
    }

    /// <summary>
    /// HttpMessage to get changes from the server.
    /// </summary>
    [DataContract(Name = "changesreq"), Serializable]
    public class HttpMessageSendChangesRequest : IScopeMessage
    {
        /// <inheritdoc cref="HttpMessageSendChangesRequest" />
        public HttpMessageSendChangesRequest()
        {
        }

        /// <inheritdoc cref="HttpMessageSendChangesRequest" />
        public HttpMessageSendChangesRequest(SyncContext context, ScopeInfoClient cScopeInfoClient)
        {
            this.SyncContext = context;
            this.ScopeInfoClient = cScopeInfoClient;
            this.IsLastBatch = true;
            this.BatchCount = 0;
            this.BatchIndex = 0;
            this.Changes = new ContainerSet();
        }

        /// <inheritdoc />
        [DataMember(Name = "sc", IsRequired = true, Order = 1)]
        public SyncContext SyncContext { get; set; }

        /// <summary>
        /// Gets or sets the client scope info.
        /// </summary>
        [DataMember(Name = "scopeclient", IsRequired = false, Order = 2)]
        public ScopeInfoClient ScopeInfoClient { get; set; }

        /// <summary>
        /// Gets or sets get the current batch index.
        /// </summary>
        [DataMember(Name = "bi", IsRequired = true, Order = 3)]
        public int BatchIndex { get; set; }

        /// <summary>
        /// Gets or sets get the current batch count.
        /// </summary>
        [DataMember(Name = "bc", IsRequired = false, Order = 4)]
        public int BatchCount { get; set; }

        /// <summary>
        /// Gets or sets a value indicating whether gets or Sets if this is the last Batch to sent to server.
        /// </summary>
        [DataMember(Name = "islb", IsRequired = true, Order = 5)]
        public bool IsLastBatch { get; set; }

        /// <summary>
        /// Gets or sets changes to send.
        /// </summary>
        [DataMember(Name = "changes", IsRequired = true, Order = 6)]
        public ContainerSet Changes { get; set; }

        /// <summary>
        /// Gets or sets client last sync timestamp.
        /// </summary>
        [DataMember(Name = "clst", IsRequired = false, Order = 7)] // IsRequired = false to preserve backward compat
        public long ClientLastSyncTimestamp { get; set; }

        /// <summary>
        /// Gets or sets pre 0.9.6 old ScopeInfo object.
        /// </summary>
        [DataMember(Name = "scope", IsRequired = false, Order = 8)] // IsRequired = false to preserve backward compat
        public OldScopeInfo OldScopeInfo { get; set; }
    }

    /// <summary>
    /// HttpMessage containing a schema from the server.
    /// </summary>
    [DataContract(Name = "ensureschemares"), Serializable]
    public class HttpMessageEnsureSchemaResponse : IScopeMessage
    {
        /// <inheritdoc cref="HttpMessageEnsureSchemaResponse" />
        public HttpMessageEnsureSchemaResponse()
        {
        }

        /// <inheritdoc cref="HttpMessageEnsureSchemaResponse" />
        public HttpMessageEnsureSchemaResponse(SyncContext context, ScopeInfo sScopeInfo)
        {
            this.SyncContext = context ?? throw new ArgumentNullException(nameof(context));
            this.ServerScopeInfo = sScopeInfo ?? throw new ArgumentNullException(nameof(sScopeInfo));
            this.Schema = sScopeInfo.Schema;
        }

        /// <inheritdoc />
        [DataMember(Name = "sc", IsRequired = true, Order = 1)]
        public SyncContext SyncContext { get; set; }

        /// <summary>
        /// Gets or Sets the schema because the ServerScopeInfo won't have it since it's marked (on purpose) as IgnoreDataMember (and then not serialized).
        /// </summary>
        [DataMember(Name = "schema", IsRequired = true, Order = 2)]
        public SyncSet Schema { get; set; }

        /// <summary>
        /// Gets or Sets the server scope info, from server.
        /// </summary>
        [DataMember(Name = "ssi", IsRequired = true, Order = 3)]
        public ScopeInfo ServerScopeInfo { get; set; }
    }

    /// <summary>
    /// HttpMessage containing scopes from the server.
    /// </summary>
    [DataContract(Name = "ensurescopesres"), Serializable]
    public class HttpMessageEnsureScopesResponse : IScopeMessage
    {
        /// <inheritdoc cref="HttpMessageEnsureScopesResponse"/>
        public HttpMessageEnsureScopesResponse()
        {
        }

        /// <inheritdoc cref="HttpMessageEnsureScopesResponse"/>
        public HttpMessageEnsureScopesResponse(SyncContext context, ScopeInfo sScopeInfo)
        {
            this.SyncContext = context ?? throw new ArgumentNullException(nameof(context));
            this.ServerScopeInfo = sScopeInfo ?? throw new ArgumentNullException(nameof(sScopeInfo));
        }

        /// <inheritdoc />
        [DataMember(Name = "sc", IsRequired = true, Order = 1)]
        public SyncContext SyncContext { get; set; }

        /// <summary>
        /// Gets or Sets the schema option (without schema itself, that is not serializable).
        /// </summary>
        [DataMember(Name = "serverscope", IsRequired = true, Order = 2)]
        public ScopeInfo ServerScopeInfo { get; set; }
    }

    /// <summary>
    /// HttpMessage to get scopes from the server.
    /// </summary>
    [DataContract(Name = "ensurereq"), Serializable]
    public class HttpMessageEnsureScopesRequest : IScopeMessage
    {
        /// <summary>
        /// Initializes a new instance of the <see cref="HttpMessageEnsureScopesRequest"/> class.
        /// Create a new message to web remote server.
        /// Scope info table name is not provided since we do not care about it on the server side.
        /// </summary>
        public HttpMessageEnsureScopesRequest() { }

        /// <summary>
        /// Initializes a new instance of the <see cref="HttpMessageEnsureScopesRequest"/> class.
        /// Create a new message to web remote server.
        /// Scope info table name is not provided since we do not care about it on the server side.
        /// </summary>
        public HttpMessageEnsureScopesRequest(SyncContext context) => this.SyncContext = context ?? throw new ArgumentNullException(nameof(context));

        /// <inheritdoc />
        [DataMember(Name = "sc", IsRequired = true, Order = 1)]
        public SyncContext SyncContext { get; set; }
    }

    /// <summary>
    /// HttpMessage to get an hypothetical operation override from the server.
    /// </summary>
    [DataContract(Name = "opreq"), Serializable]
    public class HttpMessageOperationRequest : IScopeMessage
    {

        /// <inheritdoc cref="HttpMessageOperationRequest" />
        public HttpMessageOperationRequest() { }

        /// <inheritdoc cref="HttpMessageOperationRequest" />
        public HttpMessageOperationRequest(SyncContext context, ScopeInfo cScopeInfo, ScopeInfoClient cScopeInfoClient)
        {
            this.SyncContext = context ?? throw new ArgumentNullException(nameof(context));
            this.ScopeInfoFromClient = cScopeInfo;
            this.ScopeInfoClient = cScopeInfoClient;
        }

        /// <inheritdoc />
        [DataMember(Name = "sc", IsRequired = true, Order = 1)]
        public SyncContext SyncContext { get; set; }

        /// <summary>
        /// Gets or Sets the reference scope for local repository, stored on server.
        /// </summary>
        [DataMember(Name = "scope", IsRequired = true, Order = 2)]
        public ScopeInfo ScopeInfoFromClient { get; set; }

        /// <summary>
        /// Gets or Sets the reference scope for local repository, stored on server.
        /// </summary>
        [DataMember(Name = "scopeclient", IsRequired = true, Order = 3)]
        public ScopeInfoClient ScopeInfoClient { get; set; }
    }

    /// <summary>
    /// HttpMessage containing an hypothetical operation override from the server.
    /// </summary>
    [DataContract(Name = "opres"), Serializable]
    public class HttpMessageOperationResponse : IScopeMessage
    {
        /// <inheritdoc cref="HttpMessageOperationResponse" />
        public HttpMessageOperationResponse() { }

        /// <inheritdoc cref="HttpMessageOperationResponse" />
        public HttpMessageOperationResponse(SyncContext context, SyncOperation syncOperation)
        {
            this.SyncContext = context ?? throw new ArgumentNullException(nameof(context));
            this.SyncOperation = syncOperation;
        }

        /// <inheritdoc  />
        [DataMember(Name = "sc", IsRequired = true, Order = 1)]
        public SyncContext SyncContext { get; set; }

        /// <summary>
        /// Gets or Sets the Sync Operation sent from the server that should be run on the client.
        /// </summary>
        [DataMember(Name = "so", IsRequired = true, Order = 2)]
        public SyncOperation SyncOperation { get; set; }
    }

    /// <summary>
    /// HttpMessage to containing the remote timestamp from the server.
    /// </summary>
    [DataContract(Name = "remotetsres"), Serializable]
    public class HttpMessageRemoteTimestampResponse : IScopeMessage
    {

        /// <inheritdoc cref="HttpMessageRemoteTimestampResponse" />
        public HttpMessageRemoteTimestampResponse()
        {
        }

        /// <inheritdoc cref="HttpMessageRemoteTimestampResponse" />
        public HttpMessageRemoteTimestampResponse(SyncContext context, long remoteClientTimestamp)
        {
            this.SyncContext = context ?? throw new ArgumentNullException(nameof(context));
            this.RemoteClientTimestamp = remoteClientTimestamp;
        }

        /// <inheritdoc  />
        [DataMember(Name = "sc", IsRequired = true, Order = 1)]
        public SyncContext SyncContext { get; set; }

        /// <summary>
        /// Gets or sets the remote client timestamp generated by the server database.
        /// </summary>
        [DataMember(Name = "rct", IsRequired = true, Order = 2)]
        public long RemoteClientTimestamp { get; set; }
    }

    /// <summary>
    /// HttpMessage to get the remote timestamp from the server.
    /// </summary>
    [DataContract(Name = "remotetsreq"), Serializable]
    public class HttpMessageRemoteTimestampRequest : IScopeMessage
    {
        /// <inheritdoc cref="HttpMessageRemoteTimestampRequest" />
        public HttpMessageRemoteTimestampRequest() { }

        /// <inheritdoc cref="HttpMessageRemoteTimestampRequest" />
        public HttpMessageRemoteTimestampRequest(SyncContext context)
            => this.SyncContext = context ?? throw new ArgumentNullException(nameof(context));

        /// <inheritdoc />
        [DataMember(Name = "sc", IsRequired = true, Order = 1)]
        public SyncContext SyncContext { get; set; }
    }

    /// <summary>
    /// HttpMessage to get a summary to apply on the client, from the server.
    /// </summary>
    [DataContract(Name = "summary"), Serializable]
    public class HttpMessageSummaryResponse : IScopeMessage
    {
        /// <inheritdoc cref="HttpMessageSummaryResponse" />
        public HttpMessageSummaryResponse()
        {
        }

        /// <inheritdoc cref="HttpMessageSummaryResponse" />
        public HttpMessageSummaryResponse(SyncContext context)
            => this.SyncContext = context ?? throw new ArgumentNullException(nameof(context));

        /// <summary>
        /// Gets or Sets the SyncContext.
        /// </summary>
        [DataMember(Name = "sc", IsRequired = true, Order = 1)]
        public SyncContext SyncContext { get; set; }

        /// <summary>
        /// Gets or Sets the conflict resolution policy from the server.
        /// </summary>
        [DataMember(Name = "bi", IsRequired = false, EmitDefaultValue = false, Order = 2)]
        public BatchInfo BatchInfo { get; set; }

        /// <summary>
        /// Gets or sets the remote client timestamp generated by the server database.
        /// </summary>
        [DataMember(Name = "rct", IsRequired = false, Order = 3)]
        public long RemoteClientTimestamp { get; set; }

        /// <summary>
        /// Gets or sets the HttpStep.
        /// </summary>
        [DataMember(Name = "step", IsRequired = true, Order = 4)]
        public HttpStep Step { get; set; }

        /// <summary>
        /// Gets or Sets the container changes when in memory requested by the client.
        /// </summary>
        [DataMember(Name = "changes", IsRequired = false, EmitDefaultValue = false, Order = 5)]
        public ContainerSet Changes { get; set; }

        /// <summary>
        /// Gets or Sets the summary server changes applied on server.
        /// </summary>
        [DataMember(Name = "scs", IsRequired = false, EmitDefaultValue = false, Order = 6)]
        public DatabaseChangesSelected ServerChangesSelected { get; set; }

        /// <summary>
        /// Gets or Sets the summary client changes applied on client.
        /// </summary>
        [DataMember(Name = "cca", IsRequired = false, EmitDefaultValue = false, Order = 7)]
        public DatabaseChangesApplied ClientChangesApplied { get; set; }

        /// <summary>
        /// Gets or Sets the conflict resolution policy from the server.
        /// </summary>
        [DataMember(Name = "crp", IsRequired = false, EmitDefaultValue = false, Order = 8)]
        public ConflictResolutionPolicy ConflictResolutionPolicy { get; set; }
    }

    /// <summary>
    /// HttpMessage to send an end session request to the server.
    /// </summary>
    [DataContract(Name = "endsessionreq"), Serializable]
    public class HttpMessageEndSessionRequest : IScopeMessage
    {
        /// <inheritdoc cref="HttpMessageEndSessionRequest" />
        public HttpMessageEndSessionRequest()
        {
        }

        /// <inheritdoc cref="HttpMessageEndSessionRequest" />
        public HttpMessageEndSessionRequest(SyncContext context)
            => this.SyncContext = context ?? throw new ArgumentNullException(nameof(context));

        /// <summary>
        /// Gets or Sets the SyncContext.
        /// </summary>
        [DataMember(Name = "sc", IsRequired = true, Order = 1)]
        public SyncContext SyncContext { get; set; }

        /// <summary>
        /// Gets or sets the time when a sync sessionn started.
        /// </summary>
        [DataMember(Name = "st", IsRequired = true, Order = 2)]
        public DateTime StartTime { get; set; }

        /// <summary>
        /// Gets or sets the time when a sync session ended.
        /// </summary>
        [DataMember(Name = "ct", IsRequired = true, Order = 3)]
        public DateTime CompleteTime { get; set; }

        /// <summary>
        /// Gets or Sets the summary of client changes that where applied on the server.
        /// </summary>
        [DataMember(Name = "cas", IsRequired = false, Order = 4, EmitDefaultValue = false)]
        public DatabaseChangesApplied ChangesAppliedOnServer { get; set; }

        /// <summary>
        /// Gets or Sets the summary of server changes that where applied on the client.
        /// </summary>
        [DataMember(Name = "cac", IsRequired = false, Order = 5, EmitDefaultValue = false)]
        public DatabaseChangesApplied ChangesAppliedOnClient { get; set; }

        /// <summary>
        /// Gets or Sets the summary of snapshot changes that where applied on the client.
        /// </summary>
        [DataMember(Name = "scac", IsRequired = false, Order = 6, EmitDefaultValue = false)]
        public DatabaseChangesApplied SnapshotChangesAppliedOnClient { get; set; }

        /// <summary>
        /// Gets or Sets the summary of client changes to be applied on the server.
        /// </summary>
        [DataMember(Name = "ccs", IsRequired = false, Order = 7, EmitDefaultValue = false)]
        public DatabaseChangesSelected ClientChangesSelected { get; set; }

        /// <summary>
        /// Gets or Sets the summary of server changes selected to be applied on the client.
        /// </summary>
        [DataMember(Name = "scs", IsRequired = false, Order = 8, EmitDefaultValue = false)]
        public DatabaseChangesSelected ServerChangesSelected { get; set; }

        /// <summary>
        /// Gets or Sets the exception occured on client if any.
        /// </summary>
        [DataMember(Name = "exc", IsRequired = false, Order = 9, EmitDefaultValue = false)]
        public string SyncExceptionMessage { get; set; }
    }

    /// <summary>
    /// HttpMessage to get the end session response from the server.
    /// </summary>
    [DataContract(Name = "endsessionres"), Serializable]
    public class HttpMessageEndSessionResponse : IScopeMessage
    {
        /// <inheritdoc cref="HttpMessageEndSessionResponse" />
        public HttpMessageEndSessionResponse() { }

        /// <inheritdoc cref="HttpMessageEndSessionResponse" />
        public HttpMessageEndSessionResponse(SyncContext context)
            => this.SyncContext = context ?? throw new ArgumentNullException(nameof(context));

        /// <inheritdoc  />
        [DataMember(Name = "sc", IsRequired = true, Order = 1)]
        public SyncContext SyncContext { get; set; }
    }
}